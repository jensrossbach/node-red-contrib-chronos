<!--
Copyright (c) 2020 Jens-Uwe Rossbach

This code is licensed under the MIT License.

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
-->

<script type="text/x-red" data-template-name="chronos-switch">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red-contrib-chronos/chronos-config:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red-contrib-chronos/chronos-config:common.label.name">
    </div>
    <div class="form-row">
        <label for="node-input-config"><i class="fa fa-cog"></i> <span data-i18n="node-red-contrib-chronos/chronos-config:common.label.config"></span></label>
        <input type="text" id="node-input-config" data-i18n="[placeholder]node-red-contrib-chronos/chronos-config:common.label.config">
    </div>
    <div class="form-row" style="padding-top: 10px">
        <label for="node-input-conditionList"><i class="fa fa-sliders"></i> <span data-i18n="node-red-contrib-chronos/chronos-config:common.label.conditions"></span></label>
        <div class="form-row">
            <ol id="node-input-conditionList"></ol>
        </div>
    </div>
    <div class="form-row">
        <input id="node-input-stopOnFirstMatch" type="checkbox" style="margin-top: 0px; margin-bottom: 1px; width: auto;">
        <label for="node-input-stopOnFirstMatch" style="margin-bottom: 0px; width: auto;" data-i18n="switch.label.stopOnFirstMatch"></label>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType("chronos-switch",
    {
        category:     "chronos",
        color:        "#DEB887",
        icon:         "chronos_switch.svg",
        inputs:       1,
        outputs:      1,
        paletteLabel: "time switch",
        label: function()
        {
            return (this.name || "Time Switch");
        },
        labelStyle: function()
        {
            return (this.name ? "node_label_italic" : "");
        },
        inputLabels: function()
        {
            return this._("node-red-contrib-chronos/chronos-config:common.label.inputPort");
        },
        outputLabels: function(index)
        {
            return this.conditions[index].label;
        },
        defaults:
        {
            name:
            {
                value: ""
            },
            config:
            {
                value:    "",
                type:     "chronos-config",
                required: true
            },
            conditions:
            {
                value: [{operator: "before", operands: {type: "time", value: "", offset: 0, random: false}, label: ""}],
                validate: function(v)
                {
                    // just a simple check if there are any conditions, no detailed check of the content
                    return v.length > 0;
                }
            },
            stopOnFirstMatch:
            {
                value: false
            },
            outputs:
            {
                value: 1
            }
        },
        oneditprepare: function()
        {
            let node = this;

            let conditionList = $("#node-input-conditionList").css("min-width", "510px").css("min-height", "500px").editableList(
            {
                removable: true,
                sortable: true,
                addItem: function(item, index, data)
                {
                    const sunTimes =
                    [
                        {
                            value: "sunrise",
                            label: node._("node-red-contrib-chronos/chronos-config:common.list.sun.sunrise")
                        },
                        {
                            value: "sunriseEnd",
                            label: node._("node-red-contrib-chronos/chronos-config:common.list.sun.sunriseEnd")
                        },
                        {
                            value: "sunsetStart",
                            label: node._("node-red-contrib-chronos/chronos-config:common.list.sun.sunsetStart")
                        },
                        {
                            value: "sunset",
                            label: node._("node-red-contrib-chronos/chronos-config:common.list.sun.sunset")
                        },
                        {
                            value: "goldenHour",
                            label: node._("node-red-contrib-chronos/chronos-config:common.list.sun.goldenHour")
                        },
                        {
                            value: "goldenHourEnd",
                            label: node._("node-red-contrib-chronos/chronos-config:common.list.sun.goldenHourEnd")
                        },
                        {
                            value: "night",
                            label: node._("node-red-contrib-chronos/chronos-config:common.list.sun.night")
                        },
                        {
                            value: "nightEnd",
                            label: node._("node-red-contrib-chronos/chronos-config:common.list.sun.nightEnd")
                        },
                        {
                            value: "dawn",
                            label: node._("node-red-contrib-chronos/chronos-config:common.list.sun.dawn")
                        },
                        {
                            value: "nauticalDawn",
                            label: node._("node-red-contrib-chronos/chronos-config:common.list.sun.nauticalDawn")
                        },
                        {
                            value: "dusk",
                            label: node._("node-red-contrib-chronos/chronos-config:common.list.sun.dusk")
                        },
                        {
                            value: "nauticalDusk",
                            label: node._("node-red-contrib-chronos/chronos-config:common.list.sun.nauticalDusk")
                        },
                        {
                            value: "solarNoon",
                            label: node._("node-red-contrib-chronos/chronos-config:common.list.sun.solarNoon")
                        },
                        {
                            value: "nadir",
                            label: node._("node-red-contrib-chronos/chronos-config:common.list.sun.nadir")
                        }
                    ];

                    const moonTimes =
                    [
                        {
                            value: "rise",
                            label: node._("node-red-contrib-chronos/chronos-config:common.list.moon.rise")
                        },
                        {
                            value: "set",
                            label: node._("node-red-contrib-chronos/chronos-config:common.list.moon.set")
                        }
                    ];

                    const timeInput =
                    {
                        value: "time",
                        label: node._("node-red-contrib-chronos/chronos-config:common.label.time"),
                        icon: "fa fa-clock-o",
                        hasValue: true,
                        validate: /^(\d|0\d|1\d|2[0-3]):([0-5]\d)(:([0-5]\d))?\s*(am|AM|pm|PM)?$/
                    };

                    const sunTimeInput =
                    {
                        value: "sun",
                        label: node._("node-red-contrib-chronos/chronos-config:common.label.sun"),
                        icon: "fa fa-sun-o",
                        options: sunTimes
                    };

                    const moonTimeInput =
                    {
                        value: "moon",
                        label: node._("node-red-contrib-chronos/chronos-config:common.label.moon"),
                        icon: "fa fa-moon-o",
                        options: moonTimes
                    };

                    const customInput =
                    {
                        value: "custom",
                        label: node._("node-red-contrib-chronos/chronos-config:common.label.custom"),
                        icon: "fa fa-wrench",
                        hasValue: true,
                        validate: /^[a-zA-Z][0-9a-zA-Z_]*$/
                    };

                    const offsetInput =
                    {
                        min: -300,
                        max: 300,
                        step: 5,
                        change: function(event, ui)
                        {
                            var value = parseInt(this.value, 10);
                            var min = $(this).spinner("option", "min");
                            var max = $(this).spinner("option", "max");
                            if (isNaN(value) ||
                                (value < min))
                            {
                                $(this).spinner("value", min);
                            }
                            else if (value > max)
                            {
                                $(this).spinner("value", max);
                            }
                        }
                    };

                    let fragment = document.createDocumentFragment();
                    let operatorBox = $("<div/>", {style: "display: inline-block; vertical-align: middle; width: auto;"}).appendTo(fragment);
                    let timeBox = $("<div/>", {style: "display: inline-block; vertical-align: middle; width: auto; margin-left: 2px;"}).appendTo(fragment);
                    let weekdaysBox = $("<div/>", {style: "display: inline-block; vertical-align: middle; width: auto; margin-left: 2px;"}).appendTo(fragment);
                    let monthsBox = $("<div/>", {style: "display: inline-block; vertical-align: middle; width: auto; margin-left: 2px;"}).appendTo(fragment);
                    $("<div/>", {class: "node-input-index", style: "position: absolute; width: auto; top: 50%; right: 26px; margin-top: -9px;"})
                                        .html("&#8594; " + (index + 1))
                                        .appendTo(fragment);

                    let operator = $("<select/>", {class: "node-input-operator", style: "width: 120px;"})
                                        .append($("<option></option>").val("before").text(node._("node-red-contrib-chronos/chronos-config:common.list.operator.before")))
                                        .append($("<option></option>").val("after").text(node._("node-red-contrib-chronos/chronos-config:common.list.operator.after")))
                                        .append($("<option></option>").val("between").text(node._("node-red-contrib-chronos/chronos-config:common.list.operator.between")))
                                        .append($("<option></option>").val("outside").text(node._("node-red-contrib-chronos/chronos-config:common.list.operator.outside")))
                                        .append($("<option></option>").val("weekdays").text(node._("node-red-contrib-chronos/chronos-config:common.list.operator.weekdays")))
                                        .append($("<option></option>").val("months").text(node._("node-red-contrib-chronos/chronos-config:common.list.operator.months")))
                                        .append($("<option></option>").val("otherwise").text(node._("node-red-contrib-chronos/chronos-config:common.list.operator.otherwise")))
                                        .appendTo(operatorBox);

                    let time1Box = $("<div/>", {style: "margin-left: 4px;"}).appendTo(timeBox);
                    let time2Box = $("<div/>", {style: "margin-left: 4px; margin-top: 5px;"}).appendTo(timeBox);
                    let time1Row1 = $("<div/>").appendTo(time1Box);
                    let time1Row2 = $("<div/>", {style: "margin-top: 5px;"}).appendTo(time1Box);
                    let time2Row1 = $("<div/>").appendTo(time2Box);
                    let time2Row2 = $("<div/>", {style: "margin-top: 5px;"}).appendTo(time2Box);
                    let monthsRow1 = $("<div/>").appendTo(monthsBox);
                    let monthsRow2 = $("<div/>", {style: "margin-top: 5px;"}).appendTo(monthsBox);
                    let monthsRow3 = $("<div/>", {style: "margin-top: 5px;"}).appendTo(monthsBox);

                    let time1 = $("<input/>", {type: "text", class: "node-input-time1"})
                                        .appendTo(time1Row1)
                                        .typedInput({types: [timeInput, sunTimeInput, moonTimeInput, customInput]});
                    time1.typedInput("width", "280px");
                    let extend1 = $("<a/>", {href: "#", style: "margin-left: 6px;"})
                                        .html("<i class='fa fa-angle-double-down' aria-hidden='true'></i>")
                                        .appendTo(time1Row1);

                    let time2 = $("<input/>", {type: "text", class: "node-input-time2"})
                                        .appendTo(time2Row1)
                                        .typedInput({types: [timeInput, sunTimeInput, moonTimeInput, customInput]});
                    time2.typedInput("width", "280px");
                    let extend2 = $("<a/>", {href: "#", style: "margin-left: 6px;"})
                                        .html("<i class='fa fa-angle-double-down' aria-hidden='true'></i>")
                                        .appendTo(time2Row1);

                    $("<label/>", {style: "width: auto; margin-right: 6px;"})
                                        .text(node._("node-red-contrib-chronos/chronos-config:common.label.offset"))
                                        .appendTo(time1Row2);
                    let offset1 = $("<input/>", {class: "node-input-offset1", style: "width: 50px;"})
                                        .appendTo(time1Row2)
                                        .spinner(offsetInput);
                    let random1 = $("<input/>", {type: "checkbox", class: "node-input-random1", style: "width: auto; margin-top: 0px; margin-bottom: 1px; margin-left: 6px;"})
                                        .appendTo(time1Row2);
                    $("<label/>", {style: "margin-left: 4px; margin-bottom: 0px; width: auto;"})
                                        .text(node._("node-red-contrib-chronos/chronos-config:common.label.random"))
                                        .appendTo(time1Row2);

                    $("<label/>", {style: "width: auto; margin-right: 6px;"})
                                        .text(node._("node-red-contrib-chronos/chronos-config:common.label.offset"))
                                        .appendTo(time2Row2);
                    let offset2 = $("<input/>", {class: "node-input-offset2", style: "width: 50px;"})
                                        .appendTo(time2Row2)
                                        .spinner(offsetInput);
                    let random2 = $("<input/>", {type: "checkbox", class: "node-input-random2", style: "width: auto; margin-top: 0px; margin-bottom: 1px; margin-left: 6px;"})
                                        .appendTo(time2Row2);
                    $("<label/>", {style: "margin-left: 4px; margin-bottom: 0px; width: auto;"})
                                        .text(node._("node-red-contrib-chronos/chronos-config:common.label.random"))
                                        .appendTo(time2Row2);

                    let monday = $("<input/>", {type: "checkbox", class: "node-input-monday", style: "width: auto; margin-top: 0px; margin-bottom: 1px; margin-left: 6px;"})
                                        .appendTo(weekdaysBox);
                    $("<label/>", {style: "margin-left: 4px; margin-bottom: 0px; width: auto;"})
                                        .text(node._("node-red-contrib-chronos/chronos-config:common.list.weekday.monday")).appendTo(weekdaysBox);
                    let tuesday = $("<input/>", {type: "checkbox", class: "node-input-tuesday", style: "width: auto; margin-top: 0px; margin-bottom: 1px; margin-left: 6px;"})
                                        .appendTo(weekdaysBox);
                    $("<label/>", {style: "margin-left: 4px; margin-bottom: 0px; width: auto;"})
                                        .text(node._("node-red-contrib-chronos/chronos-config:common.list.weekday.tuesday")).appendTo(weekdaysBox);
                    let wednesday = $("<input/>", {type: "checkbox", class: "node-input-wednesday", style: "width: auto; margin-top: 0px; margin-bottom: 1px; margin-left: 6px;"})
                                        .appendTo(weekdaysBox);
                    $("<label/>", {style: "margin-left: 4px; margin-bottom: 0px; width: auto;"})
                                        .text(node._("node-red-contrib-chronos/chronos-config:common.list.weekday.wednesday")).appendTo(weekdaysBox);
                    let thursday = $("<input/>", {type: "checkbox", class: "node-input-thursday", style: "width: auto; margin-top: 0px; margin-bottom: 1px; margin-left: 6px;"})
                                        .appendTo(weekdaysBox);
                    $("<label/>", {style: "margin-left: 4px; margin-bottom: 0px; width: auto;"})
                                        .text(node._("node-red-contrib-chronos/chronos-config:common.list.weekday.thursday")).appendTo(weekdaysBox);
                    let friday = $("<input/>", {type: "checkbox", class: "node-input-friday", style: "width: auto; margin-top: 0px; margin-bottom: 1px; margin-left: 6px;"})
                                        .appendTo(weekdaysBox);
                    $("<label/>", {style: "margin-left: 4px; margin-bottom: 0px; width: auto;"})
                                        .text(node._("node-red-contrib-chronos/chronos-config:common.list.weekday.friday")).appendTo(weekdaysBox);
                    let saturday = $("<input/>", {type: "checkbox", class: "node-input-saturday", style: "width: auto; margin-top: 0px; margin-bottom: 1px; margin-left: 6px;"})
                                        .appendTo(weekdaysBox);
                    $("<label/>", {style: "margin-left: 4px; margin-bottom: 0px; width: auto;"})
                                        .text(node._("node-red-contrib-chronos/chronos-config:common.list.weekday.saturday")).appendTo(weekdaysBox);
                    let sunday = $("<input/>", {type: "checkbox", class: "node-input-sunday", style: "width: auto; margin-top: 0px; margin-bottom: 1px; margin-left: 6px;"})
                                        .appendTo(weekdaysBox);
                    $("<label/>", {style: "margin-left: 4px; margin-bottom: 0px; width: auto;"})
                                        .text(node._("node-red-contrib-chronos/chronos-config:common.list.weekday.sunday")).appendTo(weekdaysBox);

                    let january = $("<input/>", {type: "checkbox", class: "node-input-january", style: "width: auto; margin-top: 0px; margin-bottom: 1px; margin-left: 6px;"})
                                        .appendTo(monthsRow1);
                    $("<label/>", {style: "margin-left: 4px; margin-bottom: 0px; width: 40px;"})
                                        .text(node._("node-red-contrib-chronos/chronos-config:common.list.month.january")).appendTo(monthsRow1);
                    let february = $("<input/>", {type: "checkbox", class: "node-input-february", style: "width: auto; margin-top: 0px; margin-bottom: 1px; margin-left: 6px;"})
                                        .appendTo(monthsRow1);
                    $("<label/>", {style: "margin-left: 4px; margin-bottom: 0px; width: 40px;"})
                                        .text(node._("node-red-contrib-chronos/chronos-config:common.list.month.february")).appendTo(monthsRow1);
                    let march = $("<input/>", {type: "checkbox", class: "node-input-march", style: "width: auto; margin-top: 0px; margin-bottom: 1px; margin-left: 6px;"})
                                        .appendTo(monthsRow1);
                    $("<label/>", {style: "margin-left: 4px; margin-bottom: 0px; width: 40px;"})
                                        .text(node._("node-red-contrib-chronos/chronos-config:common.list.month.march")).appendTo(monthsRow1);
                    let april = $("<input/>", {type: "checkbox", class: "node-input-april", style: "width: auto; margin-top: 0px; margin-bottom: 1px; margin-left: 6px;"})
                                        .appendTo(monthsRow1);
                    $("<label/>", {style: "margin-left: 4px; margin-bottom: 0px; width: 40px;"})
                                        .text(node._("node-red-contrib-chronos/chronos-config:common.list.month.april")).appendTo(monthsRow1);
                    let may = $("<input/>", {type: "checkbox", class: "node-input-may", style: "width: auto; margin-top: 0px; margin-bottom: 1px; margin-left: 6px;"})
                                        .appendTo(monthsRow2);
                    $("<label/>", {style: "margin-left: 4px; margin-bottom: 0px; width: 40px;"})
                                        .text(node._("node-red-contrib-chronos/chronos-config:common.list.month.may")).appendTo(monthsRow2);
                    let june = $("<input/>", {type: "checkbox", class: "node-input-june", style: "width: auto; margin-top: 0px; margin-bottom: 1px; margin-left: 6px;"})
                                        .appendTo(monthsRow2);
                    $("<label/>", {style: "margin-left: 4px; margin-bottom: 0px; width: 40px;"})
                                        .text(node._("node-red-contrib-chronos/chronos-config:common.list.month.june")).appendTo(monthsRow2);
                    let july = $("<input/>", {type: "checkbox", class: "node-input-july", style: "width: auto; margin-top: 0px; margin-bottom: 1px; margin-left: 6px;"})
                                        .appendTo(monthsRow2);
                    $("<label/>", {style: "margin-left: 4px; margin-bottom: 0px; width: 40px;"})
                                        .text(node._("node-red-contrib-chronos/chronos-config:common.list.month.july")).appendTo(monthsRow2);
                    let august = $("<input/>", {type: "checkbox", class: "node-input-august", style: "width: auto; margin-top: 0px; margin-bottom: 1px; margin-left: 6px;"})
                                        .appendTo(monthsRow2);
                    $("<label/>", {style: "margin-left: 4px; margin-bottom: 0px; width: 40px;"})
                                        .text(node._("node-red-contrib-chronos/chronos-config:common.list.month.august")).appendTo(monthsRow2);
                    let september = $("<input/>", {type: "checkbox", class: "node-input-september", style: "width: auto; margin-top: 0px; margin-bottom: 1px; margin-left: 6px;"})
                                        .appendTo(monthsRow3);
                    $("<label/>", {style: "margin-left: 4px; margin-bottom: 0px; width: 40px;"})
                                        .text(node._("node-red-contrib-chronos/chronos-config:common.list.month.september")).appendTo(monthsRow3);
                    let october = $("<input/>", {type: "checkbox", class: "node-input-october", style: "width: auto; margin-top: 0px; margin-bottom: 1px; margin-left: 6px;"})
                                        .appendTo(monthsRow3);
                    $("<label/>", {style: "margin-left: 4px; margin-bottom: 0px; width: 40px;"})
                                        .text(node._("node-red-contrib-chronos/chronos-config:common.list.month.october")).appendTo(monthsRow3);
                    let november = $("<input/>", {type: "checkbox", class: "node-input-november", style: "width: auto; margin-top: 0px; margin-bottom: 1px; margin-left: 6px;"})
                                        .appendTo(monthsRow3);
                    $("<label/>", {style: "margin-left: 4px; margin-bottom: 0px; width: 40px;"})
                                        .text(node._("node-red-contrib-chronos/chronos-config:common.list.month.november")).appendTo(monthsRow3);
                    let december = $("<input/>", {type: "checkbox", class: "node-input-december", style: "width: auto; margin-top: 0px; margin-bottom: 1px; margin-left: 6px;"})
                                        .appendTo(monthsRow3);
                    $("<label/>", {style: "margin-left: 4px; margin-bottom: 0px; width: 40px;"})
                                        .text(node._("node-red-contrib-chronos/chronos-config:common.list.month.december")).appendTo(monthsRow3);

                    operator.change(function()
                    {
                        timeBox.hide();
                        time2Box.hide();
                        weekdaysBox.hide();
                        monthsBox.hide();

                        var value = $(this).val();
                        switch (value)
                        {
                            case "before":
                            case "after":
                            {
                                timeBox.show();
                                break;
                            }
                            case "between":
                            case "outside":
                            {
                                timeBox.show();
                                time2Box.show();
                                break;
                            }
                            case "weekdays":
                            {
                                weekdaysBox.show();
                                break;
                            }
                            case "months":
                            {
                                monthsBox.show();
                                break;
                            }
                        }
                    });

                    function showExtensionRow1()
                    {
                        time1Row2.show();
                        extend1.html("<i class='fa fa-angle-double-up' aria-hidden='true'></i>");
                    }

                    function hideExtensionRow1()
                    {
                        time1Row2.hide();
                        extend1.html("<i class='fa fa-angle-double-down' aria-hidden='true'></i>");

                        offset1.spinner("value", 0);
                        random1.prop("checked", false);
                    }

                    function showExtensionRow2()
                    {
                        time2Row2.show();
                        extend2.html("<i class='fa fa-angle-double-up' aria-hidden='true'></i>");
                    }

                    function hideExtensionRow2()
                    {
                        time2Row2.hide();
                        extend2.html("<i class='fa fa-angle-double-down' aria-hidden='true'></i>");

                        offset2.spinner("value", 0);
                        random2.prop("checked", false);
                    }

                    extend1.click(function()
                    {
                        if (time1Row2.is(":hidden"))
                        {
                            showExtensionRow1();
                        }
                        else
                        {
                            hideExtensionRow1();
                        }
                    });

                    extend2.click(function()
                    {
                        if (time2Row2.is(":hidden"))
                        {
                            showExtensionRow2();
                        }
                        else
                        {
                            hideExtensionRow2();
                        }
                    });

                    hideExtensionRow1();
                    hideExtensionRow2();

                    if (!("operator" in data))
                    {
                        data = {operator: "before", operands: {type: "time", value: "", offset: 0, random: false}, label: ""};
                    }

                    operator.val(data.operator);

                    if ((data.operator == "before") || (data.operator == "after"))
                    {
                        time1.typedInput("type", data.operands.type);
                        time1.typedInput("value", data.operands.value);
                        if (data.operands.offset &&  // backwards compatibility to v1.0.2
                            (data.operands.offset != 0))
                        {
                            offset1.spinner("value", data.operands.offset);
                            random1.prop("checked", data.operands.random);
                            showExtensionRow1();
                        }
                    }
                    else if ((data.operator == "between") || (data.operator == "outside"))
                    {
                        time1.typedInput("type", data.operands[0].type);
                        time1.typedInput("value", data.operands[0].value);
                        time2.typedInput("type", data.operands[1].type);
                        time2.typedInput("value", data.operands[1].value);
                        if (data.operands[0].offset &&  // backwards compatibility to v1.0.2
                            (data.operands[0].offset != 0))
                        {
                            offset1.spinner("value", data.operands[0].offset);
                            random1.prop("checked", data.operands[0].random);
                            showExtensionRow1();
                        }
                        if (data.operands[1].offset &&  // backwards compatibility to v1.0.2
                            (data.operands[1].offset != 0))
                        {
                            offset2.spinner("value", data.operands[1].offset);
                            random2.prop("checked", data.operands[1].random);
                            showExtensionRow2();
                        }
                    }
                    else if (data.operator == "weekdays")
                    {
                        sunday.prop("checked", data.operands[0]);
                        monday.prop("checked", data.operands[1]);
                        tuesday.prop("checked", data.operands[2]);
                        wednesday.prop("checked", data.operands[3]);
                        thursday.prop("checked", data.operands[4]);
                        friday.prop("checked", data.operands[5]);
                        saturday.prop("checked", data.operands[6]);
                    }
                    else if (data.operator == "months")
                    {
                        january.prop("checked", data.operands[0]);
                        february.prop("checked", data.operands[1]);
                        march.prop("checked", data.operands[2]);
                        april.prop("checked", data.operands[3]);
                        may.prop("checked", data.operands[4]);
                        june.prop("checked", data.operands[5]);
                        july.prop("checked", data.operands[6]);
                        august.prop("checked", data.operands[7]);
                        september.prop("checked", data.operands[8]);
                        october.prop("checked", data.operands[9]);
                        november.prop("checked", data.operands[10]);
                        december.prop("checked", data.operands[11]);
                    }

                    operator.change();
                    item[0].appendChild(fragment);
                },
                removeItem: function(item)
                {
                    let conditionList = $("#node-input-conditionList").editableList("items");
                    conditionList.each(function(index)
                    {
                        $(this).find(".node-input-index").html("&#8594; " + (index + 1));
                    });
                },
                sortItems: function(items)
                {
                    items.each(function(index)
                    {
                        $(this).find(".node-input-index").html("&#8594; " + (index + 1));
                    });
                }
            });

            node.conditions.forEach(data =>
            {
                conditionList.editableList("addItem", data);
            });
        },
        oneditsave: function()
        {
            let node = this;

            const WEEKDAYS =
            [
                node._("node-red-contrib-chronos/chronos-config:common.list.weekday.sunday"),
                node._("node-red-contrib-chronos/chronos-config:common.list.weekday.monday"),
                node._("node-red-contrib-chronos/chronos-config:common.list.weekday.tuesday"),
                node._("node-red-contrib-chronos/chronos-config:common.list.weekday.wednesday"),
                node._("node-red-contrib-chronos/chronos-config:common.list.weekday.thursday"),
                node._("node-red-contrib-chronos/chronos-config:common.list.weekday.friday"),
                node._("node-red-contrib-chronos/chronos-config:common.list.weekday.saturday")
            ];

            const MONTHS =
            [
                node._("node-red-contrib-chronos/chronos-config:common.list.month.january"),
                node._("node-red-contrib-chronos/chronos-config:common.list.month.february"),
                node._("node-red-contrib-chronos/chronos-config:common.list.month.march"),
                node._("node-red-contrib-chronos/chronos-config:common.list.month.april"),
                node._("node-red-contrib-chronos/chronos-config:common.list.month.may"),
                node._("node-red-contrib-chronos/chronos-config:common.list.month.june"),
                node._("node-red-contrib-chronos/chronos-config:common.list.month.july"),
                node._("node-red-contrib-chronos/chronos-config:common.list.month.august"),
                node._("node-red-contrib-chronos/chronos-config:common.list.month.september"),
                node._("node-red-contrib-chronos/chronos-config:common.list.month.october"),
                node._("node-red-contrib-chronos/chronos-config:common.list.month.november"),
                node._("node-red-contrib-chronos/chronos-config:common.list.month.december")
            ];

            let conditionList = $("#node-input-conditionList").editableList("items");
            node.conditions = [];
            node.outputs = 0;

            conditionList.each(function(index)
            {
                let data = {};

                let operator = $(this).find(".node-input-operator");
                let time1 = $(this).find(".node-input-time1");
                let time2 = $(this).find(".node-input-time2");
                let offset1 = $(this).find(".node-input-offset1");
                let offset2 = $(this).find(".node-input-offset2");
                let random1 = $(this).find(".node-input-random1");
                let random2 = $(this).find(".node-input-random2");
                let monday = $(this).find(".node-input-monday");
                let tuesday = $(this).find(".node-input-tuesday");
                let wednesday = $(this).find(".node-input-wednesday");
                let thursday = $(this).find(".node-input-thursday");
                let friday = $(this).find(".node-input-friday");
                let saturday = $(this).find(".node-input-saturday");
                let sunday = $(this).find(".node-input-sunday");
                let january = $(this).find(".node-input-january");
                let february = $(this).find(".node-input-february");
                let march = $(this).find(".node-input-march");
                let april = $(this).find(".node-input-april");
                let may = $(this).find(".node-input-may");
                let june = $(this).find(".node-input-june");
                let july = $(this).find(".node-input-july");
                let august = $(this).find(".node-input-august");
                let september = $(this).find(".node-input-september");
                let october = $(this).find(".node-input-october");
                let november = $(this).find(".node-input-november");
                let december = $(this).find(".node-input-december");

                data.operator = operator.val();
                data.label = node._("node-red-contrib-chronos/chronos-config:common.list.operator." + data.operator);

                if ((data.operator == "before") || (data.operator == "after"))
                {
                    data.operands = {};
                    data.operands.type = time1.typedInput("type");
                    data.operands.value = time1.typedInput("value");
                    data.operands.offset = offset1.spinner("value");
                    data.operands.random = random1.prop("checked");

                    if ((data.operands.type == "time") || (data.operands.type == "custom"))
                    {
                        data.label += " " + data.operands.value;
                    }
                    else
                    {
                        data.label += " " + node._("node-red-contrib-chronos/chronos-config:common.list." + data.operands.type + "." + data.operands.value);
                    }
                }
                else if ((data.operator == "between") || (data.operator == "outside"))
                {
                    data.operands = [{}, {}];
                    data.operands[0].type = time1.typedInput("type");
                    data.operands[0].value = time1.typedInput("value");
                    data.operands[0].offset = offset1.spinner("value");
                    data.operands[0].random = random1.prop("checked");
                    data.operands[1].type = time2.typedInput("type");
                    data.operands[1].value = time2.typedInput("value");
                    data.operands[1].offset = offset2.spinner("value");
                    data.operands[1].random = random2.prop("checked");

                    data.label += " ";
                    if ((data.operands[0].type == "time") || (data.operands[0].type == "custom"))
                    {
                        data.label += data.operands[0].value;
                    }
                    else
                    {
                        data.label += node._("node-red-contrib-chronos/chronos-config:common.list." + data.operands[0].type + "." + data.operands[0].value);
                    }
                    data.label += " " + node._("switch.label.and") + " ";
                    if ((data.operands[1].type == "time") || (data.operands[1].type == "custom"))
                    {
                        data.label += data.operands[1].value;
                    }
                    else
                    {
                        data.label += node._("node-red-contrib-chronos/chronos-config:common.list." + data.operands[1].type + "." + data.operands[1].value);
                    }
                }
                else if (data.operator == "weekdays")
                {
                    data.operands = [false, false, false, false, false, false, false];
                    data.operands[0] = sunday.prop("checked");
                    data.operands[1] = monday.prop("checked");
                    data.operands[2] = tuesday.prop("checked");
                    data.operands[3] = wednesday.prop("checked");
                    data.operands[4] = thursday.prop("checked");
                    data.operands[5] = friday.prop("checked");
                    data.operands[6] = saturday.prop("checked");

                    for (let i=0; i<7; ++i)
                    {
                        if (data.operands[i])
                        {
                            data.label += " " + WEEKDAYS[i];
                        }
                    }
                }
                else if (data.operator == "months")
                {
                    data.operands = [false, false, false, false, false, false, false, false, false, false, false, false];
                    data.operands[0] = january.prop("checked");
                    data.operands[1] = february.prop("checked");
                    data.operands[2] = march.prop("checked");
                    data.operands[3] = april.prop("checked");
                    data.operands[4] = may.prop("checked");
                    data.operands[5] = june.prop("checked");
                    data.operands[6] = july.prop("checked");
                    data.operands[7] = august.prop("checked");
                    data.operands[8] = september.prop("checked");
                    data.operands[9] = october.prop("checked");
                    data.operands[10] = november.prop("checked");
                    data.operands[11] = december.prop("checked");

                    for (let i=0; i<12; ++i)
                    {
                        if (data.operands[i])
                        {
                            data.label += " " + MONTHS[i];
                        }
                    }
                }

                node.conditions.push(data);
                node.outputs++;
            });
        }
    });
</script>
